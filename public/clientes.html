<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Clientes Asignados</title>
  <link rel="stylesheet" href="style.css" />
  <script>
    /* El callback lo usa script.js cuando inyecta Google Maps con la key */
    function inicializarMapa() {
      if (typeof window.googleMapsApiLoadedCallback === 'function') {
        window.googleMapsApiLoadedCallback();
      }
    }
  </script>
  <!-- NO cargues aquÃ­ Google Maps sin key -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

<div id="floatingMessage" class="hidden">
  Hecho con ğŸ§¡ por Leonardo Luna
</div>

<h1>ğŸ“ Dashboard de Llamadas</h1>
<p>Bienvenido, <span id="nombreUsuario"></span> |
  <button onclick="cerrarSesion()" style="float:right;">ğŸ”’ Cerrar SesiÃ³n</button>
</p>

<!-- ===== SUPERADMIN: seleccionar empresa activa ===== -->
<div id="seccionEmpresas" class="seccion-card hidden" style="margin-bottom:16px;">
  <h2>ğŸ¢ Alta de Empresas (Superadmin)</h2>
  <div class="form-row">
    <input id="empresaNombre" placeholder="Nombre de la empresa" />
    <input id="empresaAdminNombre" placeholder="Usuario admin" />
    <input id="empresaAdminPassword" type="password" placeholder="ContraseÃ±a admin" />
    <button onclick="crearEmpresa()" class="button-success">Crear Empresa</button>
  </div>
  <p id="empresasMensaje" class="info"></p>

  <div style="margin-top:12px">
    <button onclick="listarEmpresas()" class="button-primary">Listar Empresas</button>
    <ul id="listaEmpresas"></ul>
  </div>

  <!-- NUEVO: selector para entrar como empresa -->
  <div style="margin-top:16px; border-top:1px solid #ddd; padding-top:12px;">
    <h3>ğŸ‘ï¸ Entrar como empresa</h3>
    <div class="form-row">
      <select id="empresaActivaSelect">
        <option value="">-- Selecciona empresa --</option>
      </select>
      <button class="button-purple" onclick="activarEmpresaParaSuperadmin()">Entrar</button>
      <button class="button-danger" onclick="salirDeEmpresaActiva()">Salir</button>
    </div>
    <p id="empresaActivaMsg" class="info"></p>
  </div>
</div>
<!-- ===== FIN SUPERADMIN ===== -->

<div id="seccionAdmin" class="hidden seccion-card">
  <h2>Panel de AdministraciÃ³n</h2>

  <div class="kpi-section-card">
    <h3>ğŸ“Š EstadÃ­sticas Generales (KPIs)</h3>
    <div class="kpi-grid">
      <div class="kpi-card"><h4>Clientes Totales</h4><p id="kpiClientesTotales" class="kpi-value">...</p></div>
      <div class="kpi-card"><h4>Clientes Asignados</h4><p id="kpiClientesAsignados" class="kpi-value">...</p></div>
      <div class="kpi-card"><h4>Pendientes de Asignar</h4><p id="kpiClientesPendientes" class="kpi-value">...</p></div>
      <div class="kpi-card"><h4>Llamadas Registradas</h4><p id="kpiLlamadasTotales" class="kpi-value">...</p></div>
      <div class="kpi-card"><h4>Monto Total Cobrado</h4><p id="kpiMontoCobrado" class="kpi-value">...</p></div>
      <div class="kpi-card"><h4>Efectividad Llamadas (%)</h4><p id="kpiEfectividadLlamadas" class="kpi-value">...</p></div>
      <div class="kpi-card"><h4>Clientes Procesados Hoy</h4><p id="kpiClientesProcesadosHoy" class="kpi-value">...</p></div>
    </div>
    <button onclick="cargarKPIs()" class="kpi-update-button">Actualizar KPIs</button>
  </div>

  <div class="kpi-section-card kpi-performance-background">
    <h3>ğŸ“ˆ Rendimiento de Gestores y Bonos</h3>
    <div class="form-row" style="margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
        <label for="fechaInicioBonos" style="white-space: nowrap;">Fecha Inicio Periodo:</label>
        <input type="date" id="fechaInicioBonos" style="flex-grow: 1; min-width: 150px;">
        <button onclick="cargarKPIsConFecha()" class="button-primary" style="flex-shrink: 0;">Aplicar Fecha</button>
    </div>
    <div style="max-height: 400px; overflow-y: auto;">
      <table id="tablaRendimientoGestores">
        <thead>
          <tr>
            <th>Gestor</th>
            <th>Monto Cobrado</th>
            <th>Efectividad (%)</th>
            <th>Total Llamadas</th>
            <th>Salario Base Ganado</th>
            <th>% Bono Ganado</th>
            <th>PrÃ³ximo Nivel Objetivo</th>
            <th>% Cuota PrÃ³ximo Nivel</th>
            <th>Monto Proyectado (15 dÃ­as)</th>
            <th>Tendencia</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <button onclick="cargarKPIs()" class="kpi-update-button kpi-performance-button">Actualizar Rendimiento</button>
  </div>

  <div class="admin-section-card">
    <h3>ğŸ“¤ Subir Clientes desde Excel</h3>
    <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" onchange="procesarArchivo(event)" />
    <p id="mensajeExcel" class="info"></p>
    <button onclick="limpiarClientes()" class="button-danger">ğŸ§¹ Limpiar Todos los Clientes</button>
  </div>

  <div class="admin-section-card">
    <h3>ğŸ‘¥ Gestionar Usuarios</h3>
    <div class="form-row">
      <input type="text" id="nuevoUsuarioNombre" placeholder="Nombre de usuario" required />
      <input type="password" id="nuevoUsuarioPassword" placeholder="ContraseÃ±a" required />
      <button onclick="agregarUsuario()" class="button-success">â• Agregar Usuario</button>
    </div>
    <p class="admin-message"></p>

    <table id="tablaUsuarios">
      <thead>
        <tr><th>ID</th><th>Nombre</th><th>AcciÃ³n</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div id="seccionAsignacion" class="hidden seccion-card">
  <h2>ğŸ“Œ AsignaciÃ³n de Clientes (Clientes no asignados)</h2>
  <div class="form-row">
    <input type="text" id="filtroCliente" placeholder="Buscar cliente..." oninput="filtrarClientes()" />
    <button onclick="guardarAsignaciones()" class="button-primary">ğŸ’¾ Guardar Asignaciones Individuales</button>
  </div>

  <div class="mass-assign-section">
    <h3>AsignaciÃ³n Masiva</h3>
    <select id="massAssignUserSelect"><option value="">-- Seleccionar usuario --</option></select>
    <button onclick="asignarClientesMasivamente()" class="button-purple">ğŸš€ Asignar Clientes Seleccionados</button>
    <p id="massAssignMessage" class="info"></p>
  </div>

  <div style="max-height: 500px; overflow-y: auto;">
    <table id="tablaAsignarClientes">
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAllClients" onclick="toggleAllClients(this)"></th>
          <th>Cliente</th>
          <th>TelÃ©fono</th>
          <th>DirecciÃ³n</th>
          <th>Tarifa</th>
          <th>Saldo Exigible</th>
          <th>Saldo</th>
          <th>Usuario Asignado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="seccion-card">
  <h2>Mis Clientes Asignados</h2>
  <div style="max-height: 500px; overflow-y: auto;">
    <table id="tablaClientes">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>TelÃ©fono</th>
          <th>DirecciÃ³n</th>
          <th>Tarifa</th>
          <th>Saldo Exigible</th>
          <th>Saldo</th>
          <th>Monto Cobrado</th>
          <th>Resultado</th>
          <th>Observaciones</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<div class="seccion-card">
  <h2>Mapa de Clientes y Gestores</h2>
  <div class="map-container">
    <div id="mapa"></div>
    <div id="info-ruta">
      <p>Presiona el botÃ³n para cargar el mapa.</p>
      <button onclick="inicializarMapaManual()" class="button-map">ğŸ—ºï¸ Recargar Mapa / Ubicaciones</button>
    </div>
  </div>
</div>

<div class="seccion-card">
  <h2>Reporte General</h2>
  <div class="form-row">
    <button onclick="cargarReporte()" class="button-report">ğŸ”„ Mostrar Todos los Registros</button>
    <button onclick="exportarReporte()" class="button-export">ğŸ“„ Exportar a Excel</button>
  </div>
  <p class="report-message"></p>

  <div style="max-height: 500px; overflow-y: auto;">
    <table id="tablaReporte">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Cliente</th>
          <th>Resultado</th>
          <th>Monto Cobrado</th>
          <th>Fecha</th>
          <th>Observaciones</th>
          <th>Tarifa</th>
          <th>Saldo Exigible</th>
          <th>Saldo</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<p><a href="/">â† Volver al inicio</a></p>

<script src="script.js"></script>
</body>
</html>
